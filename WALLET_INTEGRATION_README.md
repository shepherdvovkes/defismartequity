# Интеграция MetaMask с автоматическим подключением

## Обзор

Эта система обеспечивает автоматическое подключение к MetaMask и отображение токенов DEFI в кошельке пользователя. Основные возможности:

- ✅ **Автоматическое подключение** при загрузке страницы
- ✅ **Отображение токенов** в MetaMask
- ✅ **Автоматическое переподключение** при обновлении страницы
- ✅ **Управление сетями** (автоматическое переключение на Sepolia)
- ✅ **Синхронизация состояния** между вкладками браузера

## Архитектура

### 1. WalletContext (`utils/walletContext.js`)
Центральный контекст для управления состоянием кошелька:

```javascript
const {
  isConnected,        // Статус подключения
  account,           // Адрес кошелька
  network,           // Текущая сеть
  ethBalance,        // Баланс ETH
  tokenBalance,      // Баланс DEFI токенов
  loading,           // Состояние загрузки
  error,             // Ошибки
  connectWallet,     // Функция подключения
  disconnectWallet,  // Функция отключения
  refreshData,       // Обновление данных
  switchToSepolia    // Переключение на Sepolia
} = useWallet();
```

### 2. WalletStatus (`components/WalletStatus.js`)
Компонент для отображения статуса подключения кошелька:

- Показывает текущий статус подключения
- Отображает балансы ETH и DEFI
- Позволяет переключаться между сетями
- Автоматически определяет правильную сеть

### 3. TokenDisplay (`components/TokenDisplay.js`)
Компонент для работы с токенами:

- Отображает баланс DEFI токенов
- Позволяет добавить токен в MetaMask
- Показывает информацию о токене
- Предоставляет инструкции по ручному добавлению

### 4. CopyNotification (`components/CopyNotification.js`)
Универсальный компонент для копирования с уведомлениями:

- Копирует текст в буфер обмена
- Показывает уведомление об успешном копировании
- Анимированные переходы

## Использование

### Базовая интеграция

```javascript
import { useWallet } from '../utils/walletContext';

function MyComponent() {
  const { isConnected, account, connectWallet } = useWallet();
  
  return (
    <div>
      {!isConnected ? (
        <button onClick={connectWallet}>Подключить кошелек</button>
      ) : (
        <p>Подключен: {account}</p>
      )}
    </div>
  );
}
```

### Отображение статуса кошелька

```javascript
import WalletStatus from '../components/WalletStatus';

function MyPage() {
  return (
    <div>
      <WalletStatus />
      {/* Остальной контент */}
    </div>
  );
}
```

### Отображение токенов

```javascript
import TokenDisplay from '../components/TokenDisplay';

function MyPage() {
  return (
    <div>
      <TokenDisplay />
      {/* Остальной контент */}
    </div>
  );
}
```

## Автоматическое подключение

### Как это работает

1. **При загрузке страницы** система проверяет наличие MetaMask
2. **Если кошелек был подключен ранее**, происходит автоматическое переподключение
3. **Состояние сохраняется** в localStorage для персистентности
4. **Слушатели событий** отслеживают изменения в MetaMask

### События MetaMask

- `accountsChanged` - изменение аккаунтов
- `chainChanged` - изменение сети
- `connect` - подключение кошелька
- `disconnect` - отключение кошелька

## Управление сетями

### Автоматическое переключение на Sepolia

```javascript
const { switchToSepolia } = useWallet();

// Переключение на Sepolia
await switchToSepolia();
```

### Проверка сети

```javascript
const { network } = useWallet();
const isSepolia = network.includes('sepolia') || network.includes('11155111');
```

## Отображение токенов в MetaMask

### Автоматическое добавление

```javascript
// В компоненте TokenDisplay
await window.ethereum.request({
  method: 'wallet_watchAsset',
  params: {
    type: 'ERC20',
    options: {
      address: tokenAddress,
      symbol: 'DEFI',
      decimals: 18,
      image: logoURI,
    },
  },
});
```

### Ручное добавление

Пользователь может добавить токен вручную:
1. Открыть MetaMask
2. Нажать "Import tokens"
3. Вставить адрес токена
4. Подтвердить добавление

## Состояние и персистентность

### Сохраняемые данные

- `walletConnected` - статус подключения
- `walletAccount` - адрес кошелька
- `deployedContracts` - адреса развернутых контрактов

### Автоматическое восстановление

При обновлении страницы система:
1. Проверяет сохраненное состояние
2. Восстанавливает подключение к MetaMask
3. Загружает данные аккаунта
4. Инициализирует контракты

## Обработка ошибок

### Типичные ошибки

- **MetaMask не установлен** - показывается инструкция по установке
- **Неправильная сеть** - предлагается переключение на Sepolia
- **Ошибки подключения** - показывается сообщение об ошибке
- **Недостаточно средств** - информативное сообщение

### Восстановление после ошибок

- Автоматическая перезагрузка при изменении сети
- Повторные попытки подключения
- Очистка состояния при критических ошибках

## Безопасность

### Принципы

- **Никогда не запрашиваем приватные ключи**
- **Используем только публичные методы MetaMask**
- **Проверяем подпись транзакций**
- **Валидируем адреса контрактов**

### Рекомендации

- Всегда проверяйте сеть перед транзакциями
- Используйте тестовые сети для разработки
- Проверяйте адреса контрактов
- Обрабатывайте ошибки пользователя

## Производительность

### Оптимизации

- Ленивая загрузка данных
- Кэширование адресов контрактов
- Минимизация API вызовов
- Эффективное обновление состояния

### Мониторинг

- Логирование важных событий
- Отслеживание времени подключения
- Мониторинг ошибок
- Статистика использования

## Тестирование

### Ручное тестирование

1. **Подключение кошелька**
   - Установите MetaMask
   - Подключитесь к приложению
   - Проверьте отображение балансов

2. **Переключение сетей**
   - Переключитесь на Mainnet
   - Проверьте предупреждение
   - Переключитесь обратно на Sepolia

3. **Добавление токенов**
   - Инвестируйте в проект
   - Добавьте токен в MetaMask
   - Проверьте отображение

### Автоматическое тестирование

```javascript
// Пример теста
describe('Wallet Integration', () => {
  it('should connect to MetaMask', async () => {
    // Тест подключения
  });
  
  it('should display token balance', async () => {
    // Тест отображения баланса
  });
});
```

## Устранение неполадок

### Частые проблемы

1. **Кошелек не подключается**
   - Проверьте установку MetaMask
   - Убедитесь, что MetaMask разблокирован
   - Проверьте разрешения сайта

2. **Токены не отображаются**
   - Проверьте подключение к правильной сети
   - Убедитесь, что контракты развернуты
   - Проверьте баланс токенов

3. **Ошибки сети**
   - Переключитесь на Sepolia Testnet
   - Обновите страницу
   - Проверьте подключение к интернету

### Логи и отладка

```javascript
// Включение подробного логирования
localStorage.setItem('debug', 'true');

// Просмотр логов в консоли
console.log('Wallet state:', walletState);
```

## Заключение

Эта система обеспечивает надежную интеграцию с MetaMask и автоматическое управление состоянием кошелька. Основные преимущества:

- **Простота использования** - автоматическое подключение
- **Надежность** - обработка ошибок и восстановление
- **Безопасность** - проверки и валидация
- **Производительность** - оптимизированная загрузка данных

Для получения дополнительной помощи обратитесь к документации MetaMask или создайте issue в репозитории проекта.
