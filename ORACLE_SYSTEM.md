# Oracle System для DeFi Smart Contract

## Обзор

Система оракула обеспечивает автоматическое обновление цены ETH/USD в смарт-контракте с использованием внешних API и мониторинг расхождений цен для обеспечения безопасности и актуальности данных.

## Компоненты системы

### 1. Price Oracle (`scripts/price-oracle.js`)
- Автоматически получает актуальную цену ETH/USD с CoinGecko API
- Обновляет цену в смарт-контракте с заданной частотой (по умолчанию 5 минут)
- Включает механизм повторных попыток при ошибках
- Защита от резких изменений цены

### 2. Price Monitor (`scripts/price-monitor.js`)
- Мониторит расхождения между рыночной ценой и ценой в контракте
- Использует QuickNode для стабильных соединений
- Отправляет алерты при значительных расхождениях (>5%)
- Ведет историю изменений цен

### 3. Oracle Manager (`scripts/oracle-manager.js`)
- Управляет запуском и остановкой оракула и мониторинга
- Предоставляет единый интерфейс для управления системой
- Показывает статус всех компонентов
- Обрабатывает сигналы завершения

## Улучшения в смарт-контракте

### Новые функции
- `getPriceInfo()` - получение полной информации о цене
- `isPriceValid()` - проверка актуальности цены
- Улучшенная функция `updateEthUsdPrice()` с защитой от резких изменений

### Новые события
- `EthUsdPriceUpdated` - обновление цены с дополнительной информацией
- `PriceUpdateFailed` - ошибка обновления цены
- `PriceValidityWarning` - предупреждение о неактуальной цене

### Защитные механизмы
- Максимальное изменение цены: 50%
- Период валидности цены: 24 часа
- Максимальная цена: $100,000 за ETH

## Использование

### Запуск Oracle Manager (рекомендуется)
```bash
npm run oracle:manager <ADDRESS_CONTRACT>
```

### Запуск отдельных компонентов
```bash
# Только оракул
npm run oracle:start <ADDRESS_CONTRACT>

# Только мониторинг
npm run oracle:monitor <ADDRESS_CONTRACT>
```

### Тестирование
```bash
npm run test:oracle
```

## Настройка

### Переменные окружения
Убедитесь, что в `.env` файле настроены:
- `COINGECKO_API_KEY` - API ключ CoinGecko
- `QUICKNODE_API_KEY` - API ключ QuickNode
- `SEPOLIA_URL` - URL для подключения к сети
- `PRIVATE_KEY` - приватный ключ для подписи транзакций

### Настройка частоты обновления
В файлах скриптов можно изменить:
- `updateInterval` - интервал обновления цены (по умолчанию 5 минут)
- `monitoringInterval` - интервал мониторинга (по умолчанию 2 минуты)
- `alertThreshold` - порог для алертов (по умолчанию 5%)

## Мониторинг и алерты

### Статус системы
Oracle Manager показывает:
- Статус оракула (работает/остановлен)
- Время последнего обновления
- Текущую цену
- Количество обновлений
- Валидность цены

### Алерты
Система отправляет алерты при:
- Значительных расхождениях цен (>5%)
- Устаревании цены в контракте (>24 часов)
- Ошибках обновления цены

## Безопасность

### Защита от ошибок оракула
- Ограничение максимального изменения цены (50%)
- Проверка валидности цены
- Механизм повторных попыток
- Логирование всех операций

### Мониторинг
- Постоянное сравнение с рыночной ценой
- История изменений цен
- Автоматические алерты
- Статистика обновлений

## Развертывание

### Локальная разработка
```bash
# Компиляция контрактов
npm run compile

# Запуск тестов
npm run test:oracle

# Запуск оракула
npm run oracle:manager <CONTRACT_ADDRESS>
```

### Продакшн
Рекомендуется использовать PM2 для управления процессами:
```bash
# Создание ecosystem.config.js для PM2
pm2 start ecosystem.config.js

# Мониторинг
pm2 logs oracle-manager
pm2 status
```

## Troubleshooting

### Частые проблемы
1. **Ошибка подключения к API**
   - Проверьте API ключи в `.env`
   - Убедитесь в доступности интернета

2. **Ошибка обновления цены**
   - Проверьте права владельца контракта
   - Убедитесь в достаточности газа

3. **Большие расхождения цен**
   - Проверьте настройки порога алертов
   - Убедитесь в корректности API данных

### Логи
Все операции логируются в консоль с временными метками и уровнями важности.

## API Reference

### PriceOracle
- `initialize()` - инициализация
- `start()` - запуск
- `stop()` - остановка
- `getStatus()` - получение статуса

### PriceMonitor
- `initialize()` - инициализация
- `startMonitoring()` - запуск мониторинга
- `stopMonitoring()` - остановка мониторинга
- `getPriceHistory()` - получение истории цен

### OracleManager
- `initialize()` - инициализация
- `start()` - запуск всех компонентов
- `stop()` - остановка всех компонентов
- `showStatus()` - показ статуса
- `getContractInfo()` - информация о контракте
